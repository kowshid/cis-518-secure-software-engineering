Privileged Programs, Environment Variables, and Security
========================================================

Chapter 1: Linux Security Basics
********************************

Users and Groups
    - username / account name
    - user ID
    - groups and group IDs
    
    /etc/passwd file
        - one entry per line for each user account of the system
        - total of seven fields separated by a colon (:) symbol
        - Fields:
            Username
            Password
            User ID (UID)
            Group ID (GID)
            User ID Info
            Home directory
            Default shell/command that runs after login
    
    id command
    /etc/group file
    groups command
    
Access Control Methods
    Permission-based access control
    Access control lists (ACLs)
    Capability-based access control
    Role-based access control
    
Traditional permission-based access control

    rwx permissions for owner, group, others/world on files/directories
    
    chmod command to change permissions for files/directories
    
Initial permission and umask value

    Linux uses the following default mask and permission values:

    The system default permission values are 777 (rwxrwxrwx) for folders and
    666 (rw-rw-rw-) for files.

    The default umask for a non-root user is 002, changing the folder permissions to 775
    (rwxrwxr-x), and file permissions to 664 (rw-rw-r--).

    The default umask for a root user is 022, changing the folder permissions to 755
    (rwxr-xr-x), and file permissions to 644 (rw-r--r--).

    umask command
    
    The difference between umask and chmod is that umask changes the default permissions
    and thus the permissions for all newly created files and folders, while chmod sets
    permissions for files and folders that already exist.

sudo command - allows a permitted user to execute a command as a superuser or another user

    /etc/sudoers file
    
    seed user as a member of sudo group
    
Password authentication (something the user knows):
    
    /etc/passwd file holds user account information
    
    /etc/shadow file holds hashed passwords
        - purpose of salt field


Chapter 2: Set-UID Programs
***************************

1. What is a privileged program? Need for privileged programs?

    - /etc/passwd file: contains user account details; world readable
    
    - /etc/shadow file: contains user password details; only writable to root
    
    - "passwd" is a privileged program that modified the "/etc/shadow" file for users
        
2. Common approaches to implementing privileged programs
        - daemons or services
        - set-uid programs
    
    - In Unix, a process has three user IDs
        - real user id (UID)
        - effective user id (EUID)
        - saved user id (used to enable/disable privileges)
        
    - demonstrate how /etc/shadow file can be read by SEED user (code on pages 23 & 24)
        
        $ cat /etc/shadow       // permission denied
        
        $ cp /bin/cat ./mycat
        $ ./mycat /etc/shadow       // permission denied
        
        $ sudo chown root mycat
        $ ls -l mycat
        $ ./mycat /etc/shadow       // permission denied
        
        $ sudo chmod 4755 mycat
        $ ls -l mycat
        $ ./mycat /etc/shadow

4. Attack surfaces of Set-UID programs (see figure in slides)
        User Inputs: Explicit inputs provided by user running a program
            - user input copied into a buffer may overflow the buffer
                (buffer overflow vulnerabilities)
            - user input used as format string (format string vulnerabilities)

        System Inputs: accessing a hardcoded file in a program
            - race-condition vulnerability/attack

        Environment Variables: Hidden Inputs
            $ echo $PATH

            // compile and run myls.c
            $ gcc myls.c -o myls
            $ ./myls

            // compile ls.c
            $ gcc ls.c -o ls

            // save value of PATH environment variable
            $ OLDPATH=$PATH
            $ echo $OLDPATH

            // set PATH to include the current directory
            $ PATH=.:$PATH
            $ echo $PATH

            // run myls
            $ ./myls

            // restore PATH value and unset OLDPATH variable
            $ PATH=$OLDPATH
            $ unset OLDPATH
        
        Capability Leaking

5. Capability leaking from a Set-UID program
        
        file: ch2_cap_leak.c

        $ sudo touch /etc/zzz
        $ cat /etc/zzz      ==> empty file
        $ echo aaaaaaaaaaaaa > /etc/zzz     ==> permission denied

        $ gcc ch2_cap_leak.c -o ch2_cap_leak
        $ sudo chown root ch2_cap_leak
        $ sudo chmod 4755 ch2_cap_leak

        $ ./ch2_cap_leak
        fd is 3

        $ echo aaaaaaaaaaaa > /etc/zzz      ==> permission denied
        $ echo aaaaaaaaaaaa >&3
        $ cat /etc/zzz

        
6. Invoking external program from inside a program is quite common

    - Executing external program using system() and execve() commands

    - Invoking an external program from inside a set-uid program can pose security threat

          files: ch2_catall.c   ch2_safecatall.c
    
Lessons learned:

    - Principle of isolation (data and code separation)

    - Principle of least privilege (running a program with the minimal amount of
      privilege necessary)


Chapter 3: Environment Variables and Attacks
********************************************

1.  How a program accesses its environment variables
        ch3_pg40_1.c ch3_pg40_2.c ch3_pg40_3.c 
        
    How a process gets its environment variables
        ch3_passenv.c (Figure 3.1)
        
2.  Environment variables and shell variables are different.

    Environment variables are global system variables accessible to (inherited by) all
    the processes/users running under the operating system. They are useful to store
    system-wide values.

    Shell variables are internal variables maintained by a shell program (like bash) and
    apply only to a running shell instance.

    How to print, access, set, and delete environment and shell variables
        
        env
        printenv variable
        strings /proc/$$/environ
        
        set
        echo $variable
        export
        unset
        
    Environment variables can become shell variables and vice versa (Figure 3.2)

3. Attack surface created by use of environment variables (Figure 3.3)
        - Linker
        - External Library
        - Invoking external programs
        - Application code
        
4. Invoking External Programs (that make use of environment variables)
        ch3_vul.c ch3_cal.c
        
5. Application code making explicit use of environment variables
        ch3_print_pwd.c  (pages 56)
        
// To check which shell you are running at the moment, use one of these commands
$ echo $0

$ ps -p $$
